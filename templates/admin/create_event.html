{% extends 'base.html' %}
{% block content %}
<h2>Create Event</h2>
<form method="post" id="eventForm">
  <label>Name<input type="text" name="name" required id="eventName"></label>
  <label>Participants (exact)<input type="number" name="participants" value="1" min="1"></label>
  <fieldset>
    <label><input type="checkbox" name="has_prelims" id="has_prelims"> Has Prelims</label>
    <label><input type="checkbox" name="has_submission" id="has_submission"> Has Submission</label>
  </fieldset>

  <div id="submission_opts" style="display:none; margin-bottom: .5rem;">
    <label>Submission Max Changes<input type="number" name="submission_max_changes" value="2" min="1"></label>
  </div>

  <h4>Finals Criteria <span id="fin_validation" class="validation-error" style="display:none; color:red;">* Required</span></h4>
  <div id="fin_list"></div>
  <button type="button" id="fin_add">+ Add Criterion</button>
  <p><small>Total max: <span id="fin_total">0</span></small></p>

  <div id="pre_section" style="display:none">
    <h4>Prelims Criteria <span id="pre_validation" class="validation-error" style="display:none; color:red;">* Required</span></h4>
    <div id="pre_list"></div>
    <button type="button" id="pre_add">+ Add Criterion</button>
    <p><small>Total max: <span id="pre_total">0</span></small></p>
  </div>

  <h4 style="margin-top: .75rem;">Finals Position Points</h4>
  <p class="muted" style="margin-top:-.25rem">Points awarded for final placements. 1st, 2nd, and 3rd are mandatory; add more if needed.</p>
  <div id="pos_list"></div>
  <div style="display:flex; align-items:center; gap:.5rem; margin-bottom:.5rem;">
    <button type="button" id="pos_add">+ Add Position</button>
    <small>Only affects finals</small>
  </div>

  <button type="submit" id="submitBtn">Create</button>
</form>

<script id="data-fin" type="application/json">[]</script>
<script id="data-pre" type="application/json">[]</script>
<script id="data-pos" type="application/json">{{ (pos_points or {}) | tojson | safe }}</script>

<script>
 
  document.addEventListener('DOMContentLoaded', function() {

    let fin = [];
    try { fin = JSON.parse(document.getElementById('data-fin').textContent || '[]'); } catch(_) { fin = []; }
    if (fin.length > 0) {
      fin.forEach(c=> addRow('fin_list','crit_fin', c.name || c, c.max || c.points || 0));
    } else {
      addRow('fin_list','crit_fin');
    }
    validateForm();
  initPositions();
  });

  function addRow(containerId, prefix, nameVal='', maxVal=''){
    const c = document.getElementById(containerId);
    const div = document.createElement('div');
    div.className = 'criterion-row';
    div.style.display='grid'; 
    div.style.gridTemplateColumns='2fr 1fr auto'; 
    div.style.gap='.5rem'; 
    div.style.margin='.25rem 0';
    div.innerHTML = `
      <input type="text" name="${prefix}_name[]" placeholder="Criterion name" value="${nameVal}" required class="criterion-name">
      <input type="number" step="0.01" name="${prefix}_max[]" placeholder="Max points" value="${maxVal}" required min="0" class="criterion-max">
      <button type="button" class="secondary remove-btn">Remove</button>
    `;
    
    div.querySelector('.remove-btn').onclick = ()=>{ 
      div.remove(); 
      computeTotals(); 
      validateForm();
    };
    
  
    const inputs = div.querySelectorAll('input');
    inputs.forEach(input => {
      input.addEventListener('input', () => {
        computeTotals();
        validateForm();
      });
    });
    
    c.appendChild(div);
    computeTotals();
    validateForm();
  }

 
  function validateForm() {
    const form = document.getElementById('eventForm');
    const submitBtn = document.getElementById('submitBtn');
    const hasPrelims = document.getElementById('has_prelims').checked;
    const eventName = document.getElementById('eventName').value.trim();
    
  
    const nameValid = eventName !== '';
    
    
    const finCriteria = document.querySelectorAll('#fin_list .criterion-name');
    let finValid = finCriteria.length > 0;
    
    
    finCriteria.forEach(input => {
      if (input.value.trim() === '') {
        finValid = false;
      }
    });
    
    
    let preValid = true;
    if (hasPrelims) {
      const preCriteria = document.querySelectorAll('#pre_list .criterion-name');
      preValid = preCriteria.length > 0;
      
   
      preCriteria.forEach(input => {
        if (input.value.trim() === '') {
          preValid = false;
        }
      });
    }
    
  
    document.getElementById('fin_validation').style.display = finValid ? 'none' : 'inline';
    
    if (hasPrelims) {
      document.getElementById('pre_validation').style.display = preValid ? 'none' : 'inline';
    } else {
      document.getElementById('pre_validation').style.display = 'none';
    }
    
 
    const formValid = nameValid && finValid && (hasPrelims ? preValid : true);
    submitBtn.disabled = !formValid;
    

    if (formValid) {
      submitBtn.classList.remove('invalid');
      submitBtn.classList.add('valid');
    } else {
      submitBtn.classList.remove('valid');
      submitBtn.classList.add('invalid');
    }
    
    return formValid;
  }


  function computeTotals(){
    function sum(prefix){
      let total=0; 
      document.querySelectorAll(`input[name='${prefix}_max[]']`).forEach(i=>{ 
        total += parseFloat(i.value||0); 
      }); 
      return total;
    }
    
    const finTotal = sum('crit_fin');
    const preTotal = sum('crit_pre');
    
    document.getElementById('fin_total').textContent = finTotal.toFixed(2);
    document.getElementById('pre_total').textContent = preTotal.toFixed(2);
  }

  function initPositions(){
    const preset = JSON.parse(document.getElementById('data-pos').textContent || '{}');
    const defaults = Object.keys(preset).length ? preset : {"1":60, "2":55, "3":40, "4":30};
    const keys = Object.keys(defaults).sort((a,b)=>parseInt(a)-parseInt(b));
    keys.forEach(k=> addPosRow(k, defaults[k]));
    document.getElementById('pos_add').addEventListener('click', ()=> addPosRow('', ''));
  }

  function addPosRow(rankVal, pointsVal){
    const c = document.getElementById('pos_list');
    const div = document.createElement('div');
    div.className = 'criterion-row';
    div.style.display='grid';
    div.style.gridTemplateColumns='1fr 1fr auto';
    div.style.gap='.5rem';
    div.style.margin='.25rem 0';
    div.innerHTML = `
      <input type="number" min="1" step="1" name="pos_rank[]" placeholder="Rank (e.g., 1)" value="${rankVal}" required>
      <input type="number" min="0" step="1" name="pos_points[]" placeholder="Points" value="${pointsVal}" required>
      <button type="button" class="secondary remove-pos">Remove</button>
    `;
    div.querySelector('.remove-pos').onclick = ()=> div.remove();
    c.appendChild(div);
  }


  document.getElementById('has_prelims').addEventListener('change', function() {
    const preSec = document.getElementById('pre_section');
    preSec.style.display = this.checked ? 'block' : 'none';
    

    if (this.checked && document.querySelectorAll('#pre_list .criterion-name').length === 0) {
      addRow('pre_list','crit_pre');
    }
    
    validateForm();
  });


  {
    const hasSub = document.getElementById('has_submission');
    const subOpts = document.getElementById('submission_opts');
    function toggleSubOpts(){ subOpts.style.display = hasSub.checked ? 'block' : 'none'; }
    hasSub.addEventListener('change', toggleSubOpts);
    toggleSubOpts();
  }

  const hasSub = document.getElementById('has_submission');
  const subOpts = document.getElementById('submission_opts');
  function toggleSubOpts(){ subOpts.style.display = hasSub.checked ? 'block' : 'none'; }
  hasSub.addEventListener('change', toggleSubOpts);
  toggleSubOpts();

  
  document.getElementById('fin_add').addEventListener('click', () => {
    addRow('fin_list','crit_fin');
  });
  
  document.getElementById('pre_add').addEventListener('click', () => {
    addRow('pre_list','crit_pre');
  });


  document.getElementById('eventForm').addEventListener('submit', function(e) {
    if (!validateForm()) {
      e.preventDefault();
      alert('Please fix the validation errors before submitting.');
      return;
    }
    const ranks = Array.from(document.querySelectorAll("input[name='pos_rank[]']")).map(i=>parseInt(i.value||0));
    const must = [1,2,3];
    if (!must.every(m=>ranks.includes(m))) {
      e.preventDefault();
      alert('Please provide position points for 1st, 2nd and 3rd.');
    }
  });
</script>

<style>
  .validation-error {
    font-size: 0.8rem;
    font-weight: bold;
  }
  
  button.invalid { background-color: #7f1d1d; border-color: #7f1d1d; color: #fecaca; }
  button.valid { background-color: #14532d; border-color: #14532d; color: #bbf7d0; }
  
  .criterion-row {
    transition: all 0.3s ease;
  }
  
  .criterion-row:hover { background-color: rgba(148, 163, 184, 0.08); }
</style>
{% endblock %}